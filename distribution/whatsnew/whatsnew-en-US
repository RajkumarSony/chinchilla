Squashed some bugs and made performance improvements